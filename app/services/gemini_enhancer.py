from textwrap import dedent
from google import genai
from google.genai import types
from app.agents.common_imports import config, get_logger

logger = get_logger(__name__)


def generate(openai_article: str, query: str, article_layout: str):
    client = genai.Client(
        api_key=config.GEMINI_API_KEY,
    )

    # model = config.GEMINI_FLASH_PRO_MODEL
    model = config.GEMINI_FLASH_MODEL

    layout_info = f"The original article layout was: {article_layout}" if article_layout else "No specific article layout was initially provided. Use the layout from the input article"

    contents = [
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text=dedent(f"""
                You are an expert content editor and SEO specialist.
                Your task is to review the article below and improve it.
                The article was originally generated based on the query: "{query}".
                {layout_info}

                Please perform the following actions:
                1.  **Enhance and Extend**: Fix grammar, improve style, refine language, and extend the content where possible and relevant. Ensure the tone is engaging and informative. The article should not be reduced in size, only extended or maintained.
                2.  **SEO Optimization**: Ensure the article is SEO optimized for the query "{query}". Integrate relevant keywords naturally.
                3.  **Language Consistency**: You must maintain the language from the original_article appended below, e.g.: if the original article is in english you  must also generate and english output.
                4.  **Markdown Format**: The output must be a perfectly constructed markdown article.
                5.  **References**: Any references should be listed at the end of the article. Ensure all references are clickable if possible (though this is a text-based output, so format them as markdown links if URLs are present).
                6.  **Output**: You must only output the enhanced markdown article. Do not include any other introductory or concluding text outside of the article itself.
                7.  **No references in the content body**: You must not any references to the article body.

                <original_article>
                {openai_article}
                </original_article>
                """))
            ],
        ),
        
    ]
    tools = [
        types.Tool(google_search=types.GoogleSearch()),
    ]
    generate_content_config = types.GenerateContentConfig(
        tools=tools,
        response_mime_type="text/plain",
    )

    ## This is the stream version, but we do not need it for now
    # for chunk in client.models.generate_content_stream(
    #     model=model,
    #     contents=contents,
    #     config=generate_content_config,
    # ):
    #     print(chunk.text, end="")
    
    response = client.models.generate_content(
        model=model,
        contents=contents,
        config=generate_content_config,
    )
    
    return response.text

if __name__ == "__main__":
    example_query = "Photovoltaik im Kanton Bern: Energiesicherheit & Sparen"
    example_layout = """
1. Einleitung: Warum Photovoltaik im Kanton Bern gerade jetzt Sinn macht
2. Politische Rahmenbedingungen & Klimastrategien
3. Umweltvorteile: CO₂-Reduktion & dezentrale Resilienz
4. Regionale Gegebenheiten: Sonnenstunden, Dachausrichtung & Bauvorschriften
5. Wirtschaftlichkeit und Amortisation: Fallbeispiele & Berechnungen
6. Installation und Kostenfaktoren: Komponenten & Preise im Überblick
7. Förderprogramme & Subventionen im Kanton Bern
8. Genehmigungs- & Netzanschlussprozess: Schritt-für-Schritt
9. Pro-Tipps: Rendite steigern & Betrieb optimieren
"""
    print(generate(openai_article=dedent("""
             # Photovoltaik im Kanton Bern: Energiesicherheit & Sparen\\n\\n## Table of Contents\\n1. Einleitung: Warum Photovoltaik im Kanton Bern gerade jetzt Sinn macht\\n2. Politische Rahmenbedingungen & Klimastrategien\\n3. Umweltvorteile: CO₂-Reduktion & dezentrale Resilienz\\n4. Regionale Gegebenheiten: Sonnenstunden, Dachausrichtung & Bauvorschriften\\n5. Wirtschaftlichkeit und Amortisation: Fallbeispiele & Berechnungen\\n6. Installation und Kostenfaktoren: Komponenten & Preise im Überblick\\n7. Förderprogramme & Subventionen im Kanton Bern\\n8. Genehmigungs- & Netzanschlussprozess: Schritt-für-Schritt\\n9. Pro-Tipps: Rendite steigern & Betrieb optimieren\\n\\n## TL;DR\\nDie Energiekrise trifft Bern, doch Photovoltaik bietet eine smarte Lösung: Sie senkt Stromkosten, reduziert jährlich bis zu 5 Tonnen CO₂ und amortisiert sich dank Förderungen in 7–12 Jahren. Erfahren Sie, wie Sie Ihr Dach optimal nutzen, welche Fördermittel es gibt und mit welchen Tricks Sie Ihre Rendite über 15 % steigern können.\\n\\n---\\n\\n## Einleitung: Warum Photovoltaik im Kanton Bern gerade jetzt Sinn macht\\nStellen Sie sich vor, Sie wachen an einem sonnigen Morgen in Bern auf, blicken aus dem Fenster und wissen: Heute produziert Ihr Dach den Strom für Ihr Zuhause. Die aktuelle Energiekrise hat uns allen vor Augen geführt, wie verletzlich wir gegenüber Preisschwankungen und Lieferengpässen sind. **Photovoltaik im Kanton Bern** ist nicht nur ein Schritt in Richtung Unabhängigkeit, sondern auch ein persönlicher Beitrag zum Klimaschutz und zur Stärkung des regionalen Stromnetzes.\\n\\nDie Kombination aus zuverlässiger Technologie, attraktiven Förderprogrammen und ehrgeizigen Klimazielen macht Photovoltaik heute so reizvoll wie nie zuvor. Dieser Artikel führt Sie auf eine Reise von den politischen Weichenstellungen bis hin zu handfesten Tipps, wie Sie Ihre Rendite maximieren. Dabei greifen wir echte Zahlen aus dem Berner Mittelland auf und erzählen Ihnen, wie Sie Ihr Projekt Schritt für Schritt zum Erfolg führen.\\n\\n---\\n\\n## Politische Rahmenbedingungen & Klimastrategien\\nUnsere Reise beginnt auf der höchsten Ebene: **Politik und Strategie**. Auf nationaler Ebene hat die Schweiz mit der Energiestrategie 2050 den Vorrang für erneuerbare Energien festgeschrieben. Im Kanton Bern konkretisiert die Energiestrategie 2006–2035 dieses Ziel: Bis 2035 wollen wir die 4000-Watt-Gesellschaft erreichen und langfristig zur 2000-Watt-Gesellschaft werden. Die Stadt Bern hat im Herbst 2024 die **Energie- und Klimastrategie 2035** verabschiedet, die den Pfad bis zur Netto-Null-Emission bis 2045 vorgibt.\\n\\nDiese politischen Vorgaben sind kein Lippenbekenntnis, sondern ein kräftiger Rückenwind für private und gewerbliche Photovoltaikprojekte. Lokale Bauvorschriften werden gelockert, Solardächer finden immer seltener Einsprachen. Kantonsweite Förderprogramme gewähren zinsgünstige Darlehen und direkte Investitionsbeiträge.\\n\\n> **Pro-Tipp:** Prüfen Sie frühzeitig die aktuellen Richtlinien Ihrer Gemeinde. Oft finden sich hier zusätzliche Boni oder Vereinfachungen, die Ihr Projekt beschleunigen.\\n\\nDie klare Botschaft lautet: Wer heute in Bern in Photovoltaik investiert, wird politisch und finanziell unterstützt. Immobilienbesitzer genießen niedrigere Hürden, Unternehmen profitieren von Skaleneffekten. So entsteht eine Win-Win-Situation, die ökonomische und ökologische Ziele miteinander verbindet.\\n\\n---\\n\\n## Umweltvorteile: CO₂-Reduktion & dezentrale Resilienz\\nPhotovoltaik produziert **emissionsfreien Strom** – jederzeit dann, wenn die Sonne scheint. Eine 10 kWp-Anlage in Bern liefert im Schnitt 9 000 bis 11 000 kWh pro Jahr und spart damit 2 bis 5 Tonnen CO₂ im Vergleich zum Schweizer Strommix ein. Doch damit nicht genug:\\n\\n- Dezentrale Anlagen entlasten das Netz und minimieren **Übertragungsverluste**.\\n- Weniger fossile Brennstoffe bedeuten geringere Abhängigkeit von Energieimporten und geopolitischen Risiken.\\n- Lokale Erzeugung fördert das Bewusstsein für **nachhaltigen Ressourcenverbrauch**.\\n\n> **Did you know?** Eine einzige Tonne CO₂ entspricht in etwa 500 Litern Benzin. Durch eine 10 kWp-Anlage vermeiden Sie den Ausstoß von 1 000 bis 2 500 Litern Benzin jährlich!\\n\\nDie Umweltvorteile sind greifbar: Jeder eingesparte Kilowattstunde Solarstrom ist ein Schritt näher an den kantonalen Klimazielen. Gleichzeitig steigern Sie die Resilienz Ihres Quartiers, indem Sie das Risiko von Netzausfällen reduzieren. Der grösste Vorteil? Sie leisten aktiv einen Beitrag zu einer lebenswerten Zukunft für Bern und seine Bewohner.\\n\\n---\\n\\n## Regionale Gegebenheiten: Sonnenstunden, Dachausrichtung & Bauvorschriften\\nBern ist bekannt für seine malerische Landschaft – doch wie steht es mit der Sonneneinstrahlung? Im Berner Mittelland wurden 2024 rund **1 950 Sonnenstunden** gemessen, knapp 15 % unter dem langjährigen Mittel. Das mag auf den ersten Blick wenig erscheinen, doch selbst bei wechselhaftem Wetter erzeugt eine gut ausgerichtete PV-Anlage beachtliche Erträge.\\n\\n### Optimale Dachkonfiguration\\n- **Neigung**: 20°–45° sind ideal.\\n- **Ausrichtung**: Süddächer liefern Spitzenwerte, doch auch Ost-West-Anordnungen können bis zu 90 % der maximalen Leistung erreichen.\\n- **Flachdächer**: Mit optimierten Montagesystemen lässt sich jeder Winkel perfekt zum Himmel ausrichten.\\n\n### Genehmigungsfreiheit & Denkmalschutz\\nViele Gemeinden im Kanton Bern erlauben Solarmodule genehmigungsfrei, sofern die **Fassadengestaltung** nicht stark verändert wird. Doch Vorsicht bei historischen Gebäuden: Die Abstimmung mit der Denkmalpflege kann zusätzliche Zeit in Anspruch nehmen.\\n\n> **Expertentipp:** Ein frühzeitiges Gespräch mit dem Netzbetreiber, der Denkmalpflege und Ihren Nachbarn ist Gold wert. So vermeiden Sie teure Verzögerungen.\\n\\nWenn Sie diese regionalen Rahmenbedingungen berücksichtigen, steht dem Erfolg Ihrer PV-Anlage nichts im Wege. Jede Gemeinde hat ihre Eigenheiten – lassen Sie sich vor Ort beraten und profitieren Sie von lokalen Förderstellen.\\n\\n---\\n\\n## Wirtschaftlichkeit und Amortisation: Fallbeispiele & Berechnungen\\nKommen wir zum spannenden Teil: **Rechnet sich das Ganze wirklich?** Die Antwort lautet: Ja. Im Schweizer Mittelland erzeugt **1 kWp** durchschnittlich **1 000 kWh** Solarstrom pro Jahr. Bei einem Strompreis von 30 Rp./kWh und einer Einspeisevergütung von 14 Rp./kWh sieht die Bilanz für eine 5 kWp-Anlage so aus:\\n\\n| Posten                    | Menge       | Betrag            |\\n|---------------------------|-------------|-------------------|\\n| Jahresertrag              | 5 000 kWh   | –                 |\\n| Eigenverbrauch (30 %)     | 1 500 kWh   | 450 CHF Ersparnis |\\n| Einspeisung (70 %)        | 3 500 kWh   | 490 CHF Vergütung |\\n| Netzstrom-Zukauf (Rest)   | 3 000 kWh   | 900 CHF Kosten    |\\n| **Netto-Stromkosten mit PV** | –       | 410 CHF           |\\n| Stromkosten ohne PV       | –           | 1 500 CHF         |\\n| **Jährliche Einsparung**  | –           | **1 090 CHF**     |\\n\\n> **Aha-Moment:** Mit einer Jahresersparnis von 1 090 CHF amortisiert sich eine Nettoinvestition von 7 200 CHF in **ca. 6,6 Jahren**.\\n\\n### ROI & Langfristige Kosten\\nNach der Amortisation fließt der gesamte Ertrag in Ihre Tasche: Eine interne Rendite von über **15 % pro Jahr** ist möglich. Betriebskosten sind überschaubar:\\n\\n- Wartung & Reinigung: ca. 1 % der Investitionssumme (≈ 90 CHF/Jahr).\\n- Austausch Wechselrichter nach 10–15 Jahren: ca. 1 500 CHF.\\n\nMit klarer Strategie, steigenden Strompreisen und hoher Eigenverbrauchsquote kann sich Ihre Rendite weiter verbessern. Höhere Autarkiegrade durch Batteriespeicher oder ZEV-Modelle setzen dem Wachstum kaum Grenzen.\\n\\n---\\n\\n## Installation und Kostenfaktoren: Komponenten & Preise im Überblick\\nBevor Sie ans Werk gehen, sollten Sie wissen, woraus eine moderne PV-Anlage besteht und mit welchen Kosten Sie rechnen müssen. Hier die vier zentralen Komponenten:\\n\\n1. **Solarmodule**: Tier-1 kristalline Silizium-Module mit Wirkungsgraden von 15 %–22 %. Für 10 kWp benötigen Sie etwa 35–40 Module à 300–350 W.\\n2. **Wechselrichter**: Wandeln Gleich- in Wechselstrom. String- und Mikro-Wechselrichter gleichen Teilverschattungen aus.\\n3. **Montagesystem**: Aufdach-Lösungen sind kostengünstiger, Indach-Varianten integrieren sich architektonisch.\\n4. **Speicheroptionen**: Lithium-Ionen-Batterien (z. B. 10 kWh) kosten 1 000–2 500 CHF/kWh.\\n\\n### Preisbeispiele im Kanton Bern\\n- 3 kWp (Balkonlösung): ca. 8 400 CHF (2 800 CHF/kWp)\\n- 5 kWp: ca. 14 000 CHF (2 800 CHF/kWp)\\n- 10 kWp: ca. 28 000 CHF (2 800 CHF/kWp)\\n\\n> **Kurztipp:** Holen Sie mindestens drei Offerten von zertifizierten Fachbetrieben ein. Achten Sie auf Garantien, Servicepakete und Referenzen.\\n\\nIm Kanton Bern machen 25 %–30 % der Investitionskosten die Planung, Projektierung und Arbeitszeit aus. Lohnsätze liegen hier leicht über dem Schweizer Durchschnitt: 100–150 CHF/Stunde.\\n\\n---\\n\\n## Förderprogramme & Subventionen im Kanton Bern\\nDie Investition wird durch attraktive Fördermittel spürbar entlastet. Hier ein Überblick:\\n\\n- **Bundeseinmalvergütung (KEV)**: 380 CHF/kWp\\n- **Bundesförderung PV-Indach**: 420 CHF/kWp\\n- **Kanton Bern Leitfaden**: Bis zu 250 000 CHF pro Gebäude\\n- **Haushaltsabzug**: Handwerkerleistung steuerlich absetzbar\\n- **Kommunale Boni**: Oft einmalige Zuschüsse, je nach Gemeinde unterschiedlich\\n\n> **Wussten Sie?** Manche Gemeinden bezuschussen Batteriespeicher zusätzlich – erkundigen Sie sich unbedingt beim lokalen Energieversorger!\\n\\nEine clevere Kombination aus Bundes-, Kantons- und Gemeindebeiträgen kann Ihre Investitionskosten um bis zu 30 % senken. Nutzen Sie Online-Förderrechner und beraten Sie sich bei Ihrer regionalen Energieberatungsstelle.\\n\\n---\\n\\n## Genehmigungs- & Netzanschlussprozess: Schritt-für-Schritt\\nEin reibungsloser Ablauf spart Zeit und Nerven. So gelingt’s:\\n\\n1. **Vorabklärung**: Netzbetreiber (z. B. Energie Wasser Bern) kontaktieren – Tarife und Anschlussbedingungen klären.\\n2. **Technisches Anschlussgesuch (TAG)**: Installateur reicht Unterlagen beim Verteilnetzbetreiber ein.\\n3. **Einspeisevertrag (EEA)**: Vertrag über Rücklieferungstarife finalisieren.\\n4. **Baugesuch & Baubewilligung**: Ab 30 kWp in der Regel erforderlich.\\n5. **Installation & Zählertechnik**: Montage der Zählereinheit (Netto- oder Überschussmessung) und Inbetriebnahme.\\n\n> **Fehlerquelle vermeiden:** Stellen Sie sicher, dass alle Unterlagen vollständig sind, bevor Sie den Antrag einreichen – fehlende Dokumente verlängern das Verfahren um Wochen.\\n\\nMit dieser Anleitung sind Sie gewappnet für eine rechtssichere und effiziente Netzanbindung Ihrer PV-Anlage.\\n\\n---\\n\\n## Pro-Tipps: Rendite steigern & Betrieb optimieren\\nWenn Sie das Optimum herausholen wollen, sollten Sie folgende Strategien berücksichtigen:\\n\\n- **Speicherintegration**: Ein 5 kWh-Akku kann den Eigenverbrauch auf über 60 % steigern.\\n- **Smart-Home-Steuerung**: Automatisieren Sie Waschmaschine, Warmwasserpumpe & E-Auto-Ladung.\\n- **Monitoring-Tools**: Echtzeit-Überwachung erkennt Leistungsverluste sofort.\\n- **Regelmäßige Reinigung**: Entfernt Staub & Schmutz und vermeidet Ertragsrückgänge von bis zu 30 %.\\n- **ZEV-Modelle**: Schließen Sie sich Energiezellenverbünden an und erhöhen Sie Ihren Eigenverbrauch.\\n\n> **Quick Fact:** Mit jeder Steigerung des Eigenverbrauchs um 10 % reduziert sich die Amortisationszeit um etwa ein Jahr.\\n\nMit diesen Maßnahmen verwandeln Sie Ihre Photovoltaikanlage in ein hochprofitables Kraftwerk auf dem eigenen Dach.\\n\\n---\\n\\n## Conclusion\\nPhotovoltaik im Kanton Bern ist weit mehr als eine technische Spielerei – sie ist Ihr persönlicher Schlüssel zu **Energiesicherheit**, **Kostenersparnis** und aktivem **Klimaschutz**. Dank klarer politischer Vorgaben, umfassender Förderprogramme und solider Wirtschaftlichkeitsrechnungen steht Ihrem Ausstieg aus der Abhängigkeit von fossilen Energien nichts im Weg. Wagen Sie jetzt den Schritt: Holen Sie Offerten ein, planen Sie Ihr Dach, nutzen Sie die Zuschüsse und erleben Sie, wie aus Sonnenstrahlen spürbarer Mehrwert wird. Die Sonne wartet nicht – starten Sie noch heute in Ihre **sonnige Zukunft**!\\n\\n---\\n\\n## References\\n1. [Energieheld: Wirtschaftlichkeit von Photovoltaik-Anlagen](https://www.energieheld.ch/solaranlagen/photovoltaik/wirtschaftlichkeit) – Analysen zu Kosten, Einsparungen und Amortisation von PV-Anlagen.\\n2. [EWB Stromtarife 2025](https://www.ewb.ch/ueber-uns/medien-publikationen/medienmitteilungen/2024/stromtarife-2025.php) – Aktuelle Strompreise und Einspeisetarife der Energie Wasser Bern.\\n3. [Leitfaden Energie-Förderung Kanton Bern (WEU)](https://www.weu.be.ch/content/dam/weu/dokumente/aue/de/energiefoerderung/aue-leitfaden-de.pdf) – Detaillierte Informationen zu kantonalen Förderprogrammen.\\n4. [Energiestrategie Kanton Bern](https://www.weu.be.ch/de/start/themen/energie/energiestrategie.html) – Offizielle Ziele und Maßnahmen bis 2035.\\n5. [EVM: Lebensdauer von Solarmodulen](https://www.evm.de/privatkunden/solaranlage/lebensdauer-solarmodule-wie-lange-haelt-eine-photovoltaikanlage/) – Hintergrund zur Haltbarkeit und Garantie von Modulen.\\n6. [EWB Grundversorgung Strompreise](https://www.ewb.ch/angebot/strom/beziehen/strompreise-grundversorgung.php) – Basispreise für Bern und Region.\\n7. [Anpassung Förderbeiträge Kanton Bern](https://energieberatung-seeland.ch/de_de/anpassung-foerderbeitraege-kanton-bern/) – Übersicht aktueller kommunaler Boni.\\n8. [Heizungsmacher: Lebensdauer einer PV-Anlage](https://www.heizungsmacher.ch/wissen/lebensdauer-einer-pv-anlage-so-lange-halt-ihre-solaranlage) – Praxisbezogene Tipps zur Wartung und Austauschzyklen.\\n9. [Energieheld: Kosten einer PV-Anlage](https://www.energieheld.ch/solaranlagen/photovoltaik/kosten) – Detaillierte Preisübersicht nach Systemgrößen.\\n10. [Stadt Bern Energie- und Klimastrategie 2035](https://www.bern.ch/themen/umwelt-natur-und-energie/klima/energie-und-klimastrategie-2035) – Verbindliche städtische Zielvorgaben.\\n11. [Swissolar Batteriespeicherbericht](https://www.swissolar.ch/02_markt-politik/batteriespeicherbericht/130525_batteriespeicher_bericht_sws.pdf) – Fachbericht zur Integration von Speicherlösungen.\\n12. [BKW Stromtarife und Kosten](https://www.bkw.ch/de/strom-in-der-grundversorgung/strom-beziehen/stromkosten-rechnung/stromtarife) – Vergleich der Stromtarife in der Grundversorgung.\\n13. [Bern in Zahlen: Sonnenstunden-Statistik](https://www.bern.ch/themen/stadt-recht-und-politik/bern-in-zahlen/katost/02rauumw/jahresdaten/t-02-04-040-temperatur-niederschlag-schneefall.pdf/download) – Jahrestabellen zu Sonnenstunden und Klima.\\n14. [Swissolar: ZEV und Eigenverbrauch](https://www.swissolar.ch/de/wissen/wirtschaftlichkeit/zev-eigenverbrauch) – Erläuterung von Energiezellenverbünden.\\n15. [Energieheld: Einspeisevergütung](https://www.energieheld.ch/solaranlagen/photovoltaik/einspeiseverguetung) – Aktuelle Vergütungssätze und Regelungen.\\n16. [Statista: Sonnenstunden Schweiz](https://de.statista.com/statistik/daten/studie/297546/umfrage/sonnenstunden-in-der-schweiz-nach-ausgewaehlten-orten/) – Vergleich regionaler Sonnendaten.\\n17. [Swissolar: Neues Stromgesetz](https://www.swissolar.ch/de/wissen/neues-stromgesetz) – Auswirkungen der Gesetzesänderungen auf PV-Anlagen.\n             """), query=example_query, article_layout=example_layout))